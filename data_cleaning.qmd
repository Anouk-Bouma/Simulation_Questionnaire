---
title: "analysis_script"
format: html
editor: visual
---

<!--# Hey bestie, before submitting the final version -> ctrl + f: 'NOTE' to check if all notes are evaluated and removed -->

## Version Control

```{r}
renv::restore()

library(tidyr)
library(dplyr)
library(readxl)
library(ggplot2)
library(stringr)
library(purrr)
library(writexl)
library(openxlsx)
library(tibble)
```

## Initial simple data cleaning

```{r}
### Loading the data into R 
data <- read_excel("simulation_survey_data_direct_qualtrics_download.xlsx")

# Removing irrelevant and identifying columns:
# StartDate, EndDate, Status, RecordedDate, ResponseId, DistributionChannel
# UserLanguage
data <- data %>% select(-StartDate, -EndDate, -Status, -RecordedDate, 
                        -ResponseId, -DistributionChannel, -UserLanguage)
# Removing the first row as this contains a second header instead of data
data <- data[-1,]
```

## Participant-specific simple data cleaning

```{r}
####
## Exclude everyone that did not fill out any content-related question (Q5 and further)

# Step 1: select all columns from 15 onward (which is column where Q5 is in)
cols_from_15 <- select(data, 15:ncol(data))

# Step 2: only keep participants that have data for at least one of those selected columns (i.e, select all rows where not all selected columns are NA or -99)
data_filtered <- data %>%
  filter(rowSums(is.na(cols_from_15) | cols_from_15 == '-99') < ncol(cols_from_15))

####
## Add an ID variable to the dataset
data_filtered <- data_filtered %>%
  mutate(ID = paste0("id", row_number())) %>%
  relocate(ID) # put ID variable column as the first column of the dataset

####
# Change columns with values into type numeric
data_filtered <- data_filtered %>%
  mutate(across(
    where(~ is.character(.) &&
            all(str_detect(., "^\\d+$") | is.na(.) | str_detect(., "-99"))),
    as.numeric
  ))
```

## Save intermediate dataset to continue with

```{r}

data <- data_filtered

# Save data as Excel file
write.xlsx(data, file = "survey_intermediate_datafile.xlsx")
```

## Evaluating text results

In this block we will extract all textual results that need to be evaluated to decide what to do with them. The previously saved dataset can be useful to open when evaluating textual data because evaluating what to do with open answers might depend on other answers given by the same participant.

```{r}

# Define the text columns you want to extract
text_cols <- c("Q2_4_TEXT", "Q7a_12_TEXT", "Q7b_12_TEXT", 
               "Q10a_12_TEXT", "Q10b_12_TEXT", 
               "Q13a_12_TEXT", "Q13b_12_TEXT",
               "Q16a_15_TEXT", "Q16b_15_TEXT",
               "Q18a_10_TEXT", "Q18b_9_TEXT",
               "Q19_6_TEXT", "Q20_8_TEXT",
               "Q22_11_TEXT", "Q23_5_TEXT",
               "Q24_13_TEXT", "Q25_12_TEXT",
               "Q30")

# Create a named list of tibbles
text_list <- map(text_cols, function(col) {
  data_filtered %>%
    filter(.data[[col]] != "-99", !is.na(.data[[col]])) %>%
    select(ID, text = all_of(col))
}) %>%
  set_names(text_cols)

# Write to Excel with one sheet per column
#write_xlsx(text_list, "text_responses.xlsx")
```

## Anonymizing in Excel

Before going to the next step, the open answers were all anonymized by hand in Excel. Any part of an open answer that allows for an individual to be identified is replaced by '\[redacted\]'. This step does not change anything in terms of reproducibility of the other steps in this script.

## Load anonymized dataset to work with

```{r}

# Load the anonymized data here
data <- read.xlsx("survey_data_anonymized_raw.xlsx")
```

## Response rate and completion rate

```{r}

# Calculate reponse rate
n_invitations <- 695
n_participants <- nrow(data) # = 224
response_rate <- n_participants/n_invitations # = 0.3223

# Completion Rate
completed <- data %>%
  count(Finished)

completion_rate <- completed[2,2]/sum(completed$n) # = 0.9196
```

## Data Cleaning following evaluation of textual results

```{r}

####
# Removing participants we decided to exclude based on their answers (wrongfully included in our sample during article evaluation)
id_remove <- c("id2", "id32", "id94")
data <- data %>%
  filter(!ID %in% id_remove)


####
# Addition of new answer categories based on themes found in open answers (see codebook for details)
# For participants where their answer option in the 'other' answer option is assigned to a new category, their score for the option 'other' is recoded as a 8 (see codebook). 
# Note that coding 'other' answers to 8 is done per category, not per question to keep the code as easily interpretable as possible.
data <- data %>%
  mutate(
    Q16a_16_NEW = if_else(ID %in% c("id9", "id69"), 1, NA_real_), # Keyword: Not Applicable
    Q16a_15 = if_else(ID %in% c("id9", "id69"), 8, Q16a_15), # Q16a_15 is option 'other' -> changed to 8 (see codebook)
    .after = "Q16a_15_TEXT" # Q16a_15_NEW is placed after the last Q16 column
    ) %>%
  mutate(
    Q18a_11_NEW = if_else(ID %in% c("id9", "id156", "id161", "id108", "id139"), 1, NA_real_), # Keyword: Not Applicable
    Q18a_10 = if_else(ID %in% c("id9", "id156", "id161", "id108", "id139"), 8, Q18a_10),
    .after = "Q18a_10_TEXT"
    ) %>%
  mutate(
    Q16a_17_NEW = if_else(ID %in% c("id108", "id129", "id197", "id210"), 1, NA_real_), # Keyword: Low Occurrence
    Q16a_15 = if_else(ID %in% c("id108", "id129", "id197", "id210"), 8, Q16a_15),
    .after = "Q16a_16_NEW"
    ) %>%
  mutate(
    Q18a_12_NEW = if_else(ID %in% c("id92", "id158"), 1, NA_real_), # Keyword: Uncommon
    Q18a_10 = if_else(ID %in% c("id92", "id158"), 8, Q18a_10),
    .after = "Q18a_11_NEW"
    ) %>%
  mutate(
    Q18a_13_NEW = if_else(ID %in% c("id60", "id71", "id137", "id178"), 1, NA_real_), # Keyword: Alternative Check
    Q18a_10 = if_else(ID %in% c("id60", "id71", "id137", "id178"), 8, Q18a_10),
    .after = "Q18a_12_NEW"
    ) %>%
  mutate(
    Q20_9_NEW = if_else(ID %in% c("id27", "id36", "id105", "id165", "id191", "id204"), 1, NA_real_), # Keyword: Field
    Q20_8 = if_else(ID %in% c("id27", "id36", "id105", "id165", "id191", "id204"), 8, Q20_8),
    .after = "Q20_8_TEXT"
    ) %>%
  mutate(
    Q20_10_NEW = if_else(ID %in% c("id35", "id36", "id43", "id135", "id140"), 1, NA_real_), # Keyword: Experience
    Q20_8 = if_else(ID %in% c("id35", "id36", "id43", "id135", "id140"), 8, Q20_8),
    .after = "Q20_9_NEW"
    ) %>%
  mutate(
    Q20_11_NEW = if_else(ID %in% c("id161", "id165", "id188", "id213"), 1, NA_real_), # Keyword: Not Available
    Q20_8 = if_else(ID %in% c("id161", "id165", "id188", "id213"), 8, Q20_8),
    .after = "Q20_10_NEW"
    )

# Changing existing answers (that are clearly wrong) based on open answers
# All open answers and rationale for changing answers can be found in the supplemental materials
data <- data %>%
  # Q16a: participants that indicated they did not report missings/nonconvergence because there were none, 
  #but did not indicate this as the reasons for not reporting this information in the answer options
  mutate(Q16a_6 = if_else(ID %in% c("id96", "id159", "id164", "id178", "id199"), 1, Q16a_6)) %>%
  # id9: change answers to questions about research guidelines
  mutate(Q19_5 = if_else (ID %in% c("id9"), 1, Q19_5)) %>%
  mutate(Q19_6 = if_else (ID %in% c("id9"), 1, Q19_6)) %>%
  mutate(Q20_8 = if_else (ID %in% c("id9"), 1, Q20_8)) %>%
  mutate(Q20_8_TEXT = if_else (ID %in% c("id9"), "Report all that is relevant to the research question", Q20_8_TEXT)) %>%
  # id125: change answer to Q23_1 to TRUE
  mutate(Q23_1 = if_else(ID %in% c("id125"), 1, Q23_1)) %>%
  # id14: change answer Q24_3 to TRUE
  mutate(Q24_3 = if_else(ID %in% c("id14"), 1, Q24_3)) %>%
  # Change answers for participants that indicated that they reported all missings/nonconv. 
  # But in the comments indicated that they did not report it because there were none in their case.
  mutate(Q14 = if_else(ID %in% c("id21", "id85", "117", "122"), 3, Q14)) %>%
  mutate(Q15 = if_else(ID %in% c("id21", "id85", "117", "122"), NA_real_, Q15)) %>%
  mutate(Q16a_6 = if_else(ID %in% c("id21", "id85", "117", "122"), 1, Q16a_6)) %>%
  mutate(across(c(Q16a_1, Q16a_2, Q16a_3, Q16a_4, Q16a_5, # all answer options except for Q16a_6 set to 0 instead of NA
                  Q16a_7, Q16a_8, Q16a_9, Q16a_10, Q16a_11, 
                  Q16a_12, Q16a_13, Q16a_14, Q16a_15),
                ~ if_else(ID %in% c("id21", "id85", "117", "122"),
                          0,
                          .))) %>%
  # Change answer on slider reproducibility to missing for participant that indicated confusion over question
  mutate(Q28_1 = if_else(ID %in% c("id61"), NA, Q28_1)) %>%
  # Change answer Q25_12 to 9 for participant that did not indicate a reasons but gave a non-content related comment (see codebook)
  mutate(Q25_12 = if_else(ID %in% c("id201"), 9, Q25_12))


####
# Check if participants indicated an impossible combination in Q23 (Open Code). Q23_2 and Q23_3 cannot both be 1.
data %>%
  filter(Q23_2 == 1 & Q23_3 == 1) # Result: no impossible cases so no data changes needed.


####
# Slider check: making slider questions (Q27_1, Q28_1, Q29_1) 999 if they failed the slider check (Q26_1)
# First, change column types to numeric
data <- data %>%
  mutate(across(c(Q26_1, Q27_1, Q28_1, Q29_1), as.numeric))
# Then, make sliders NA for failed Slider Check
data <- data %>%
  mutate(across(
    c(Q27_1, Q28_1, Q29_1),
    ~ if_else(Q26_1 < 0.01 | Q26_1 > 0.99, 999, .)
  ))

```

## Variable combining

```{r}

## Creating the variable 'new_method' that indicates if one of the authors has been involved in developing one or multiple methods that are part of their paper

data <- data %>%
  mutate(new_method = case_when(Q2 == "1.0" | 
                                Q2 == "2.0" | 
                                Q3 == "1.0" ~ 1, 
                                .default = 0), .after = "Q3")
```

## Save final dataset after all cleaning steps are done

```{r}

save(data, file = "survey_data_cleaned.RData")

write.xlsx(data, file = "survey_data_cleaned.xlsx")

```
