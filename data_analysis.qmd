---
title: "data_analysis"
format: html
editor: visual
---

## Version Control

```{r}
renv::restore()

library(tidyverse)
library(readxl)
library(ggplot2)
library(stringr)
library(purrr)
library(writexl)
library(openxlsx)
```

## Loading the data

```{r}

# Load the cleaned data here
load("survey_data_cleaned.RData")

# Load questionnaire metadata
meta <- read.xlsx("question_labels.xlsx", sheet = "codebook")
```

## To do

-   Comments in code

## Plotting

For every question, there have to be the following plots:

-   Frequencies overall

-   Frequencies split over neutral/non-neutral

    <!--# Put all questions and labels into an external Excel file that can be used as the basis to plot from -->

## Specifying function for plots per question

```{r}

plot_question <- function(
    data = data, metadata = meta, question, wrap_width = 60) {
  
  # Extract relevant metadata rows for this question
  meta_group <- metadata %>%
    filter(question_group == question) %>%
    arrange(order)
  
  # Wrap the question text so long titles look clean
  wrapped_title <- stringr::str_wrap(meta_group$item[1], width = wrap_width)

  # --- MULTI-SELECT QUESTIONS (multiple columns in data) ---
  if (n_distinct(meta_group$question_code) > 1) { 
    
    # All answer options that belong to this multi-select question
    all_options <- meta_group %>%
      select(question_code, answer_label, order)
    
    # Count how many respondents selected each option
    # A left join ensures that options with 0 selections still appear
    plot_data <- all_options %>%
      left_join(
        data %>%
          pivot_longer(
            cols = all_of(meta_group$question_code),
            names_to = "question_code",
            values_to = "selected"
          ) %>%
          filter(selected == 1) %>%     # keep only chosen options
          count(question_code),         # count selections
        by = "question_code"
      ) %>%
      mutate(n = replace_na(n, 0))      # ensure missing counts become 0
    
    # Order answer labels according to metadata (not alphabetical)
    plot_data <- plot_data %>%
      mutate(answer_label = factor(answer_label, levels = meta_group$answer_label))
    
    # ----- Plot for multi-select -----
    ggplot(plot_data, aes(x = fct_reorder(answer_label, desc(order)), y = n)) +
      geom_col(fill = "#f68060", alpha = 0.6, width = 0.4) +
      coord_flip() +             # horizontal bars
      scale_y_reverse() +        # bars go right â†’ left
      geom_text(aes(label = n),  # count labels
                hjust = -0.2, size = 3) +
      scale_x_discrete(
        labels = ~ stringr::str_wrap(.x, width = wrap_width),
        position = "top"         # move y-axis labels to the right side
      ) +
      labs(x = NULL, y = "Count", title = wrapped_title) +
      theme_bw() +
      theme(
        axis.text.y = element_text(angle = 0, hjust = 1),
        plot.title.position = "plot",
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10, unit = "pt")
      )
    
  } else {
    
    # --- SINGLE-SELECT QUESTIONS (one column in data) ---
    qcol <- meta_group$question_code[1]
    
    # All options available for this question
    all_options <- meta_group %>%
      select(value, answer_label, order)
    
    # Count how many respondents selected each option
    # Left join ensures missing categories appear with 0
    plot_data <- all_options %>%
      left_join(
        data %>%
          filter(!is.na(.data[[qcol]])) %>%       # ignore missing responses
          group_by(value = .data[[qcol]]) %>%     # match metadata$value
          summarise(n = n(), .groups = "drop"),
        by = "value"
      ) %>%
      mutate(n = replace_na(n, 0))
    
    # Keep original answer order
    plot_data <- plot_data %>%
      mutate(answer_label = factor(answer_label, levels = meta_group$answer_label))
    
    # ----- Plot for single-select -----
    ggplot(plot_data, aes(x = fct_reorder(answer_label, desc(order)), y = n)) +
      geom_col(fill = "#f68060", alpha = 0.6, width = 0.4) +
      coord_flip() +
      scale_y_reverse() +
      geom_text(aes(label = n),
                hjust = -0.1, size = 3) +
      scale_x_discrete(
        labels = ~ stringr::str_wrap(.x, width = wrap_width),
        position = "top"
      ) +
      labs(x = NULL, y = "Count", title = wrapped_title) +
      theme_bw() +
      theme(
        axis.text.y = element_text(angle = 0, hjust = 1),
        plot.title.position = "plot",
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10, unit = "pt")
      )
  }
}


plot_question(data, meta, "Q16a")

```

## Making some plots

```{r}

all_questions <- c("Q2", "Q3", "Q4", "Q5", "Q6", "Q7a", "Q7b", "Q8", "Q9", "Q10a", "Q10b", "Q11", "Q12", "Q13a", "Q13b", "Q14", "Q15", "Q16a", "Q16b", 
  "Q17", "Q18a", "Q18b", "Q19", "Q20", "Q21", "Q22", "Q23", "Q24", "Q25")

for (i in 1:length(all_questions)) {
  print(plot_question(data, meta, all_questions[i]))
}

```
