---
title: "data_analysis"
format: html
editor: visual
---

## Version Control

```{r}
renv::restore()

library(tidyverse)
library(readxl)
library(ggplot2)
library(stringr)
library(purrr)
library(writexl)
library(openxlsx)
```

## Loading the data

```{r}

# Load the cleaned data here
load("survey_data_cleaned.RData")

# Load questionnaire metadata
meta <- read.xlsx("question_labels.xlsx", sheet = "codebook")
```

## Plotting

For every question, there have to be the following plots:

-   Frequencies overall

-   Frequencies split over neutral/non-neutral

    <!--# Put all questions and labels into an external Excel file that can be used as the basis to plot from -->

## Specifying function for plots per question

```{r}

plot_question <- function(
    data = data, metadata = meta, question, wrap_width = 60) {
 
  meta_group <- metadata %>%
    filter(question_group == question) %>%
    arrange(order)
  
  wrapped_title <- stringr::str_wrap(meta_group$item[1], width = wrap_width)

  if (n_distinct(meta_group$question_code) > 1) { 
   
    all_options <- meta_group %>%
      select(question_code, answer_label, order)
   
    plot_data <- all_options %>%
      left_join(
        data %>%
          pivot_longer(
            cols = all_of(meta_group$question_code),
            names_to = "question_code",
            values_to = "selected"
          ) %>%
          filter(selected == 1) %>%
          count(question_code),
        by = "question_code"
      ) %>%
      mutate(n = replace_na(n, 0))
   
    plot_data <- plot_data %>%
      mutate(answer_label = factor(answer_label, levels = meta_group$answer_label))
   
    ggplot(plot_data, aes(x = fct_reorder(answer_label, desc(order)), y = n)) +
      geom_col(fill = "#f68060", alpha = 0.6, width = 0.4) +
      coord_flip() +
      scale_y_reverse() +
      geom_text(aes(label = n),
                hjust = -0.2, size = 3) +
      scale_x_discrete(labels = ~ stringr::str_wrap(.x, width = wrap_width),
                       position = "top") +
      labs(x = NULL, y = "Count", title = wrapped_title) +
      theme_bw() +
      theme(
        axis.text.y = element_text(angle = 0, hjust = 1),   # ← corrected axis
        plot.title.position = "plot",
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10, unit = "pt")
      )
   
  } else {
   
    qcol <- meta_group$question_code[1]
   
    all_options <- meta_group %>%
      select(value, answer_label, order)
   
    plot_data <- all_options %>%
      left_join(
        data %>%
          filter(!is.na(.data[[qcol]])) %>%
          group_by(value = .data[[qcol]]) %>% 
          summarise(n = n(), .groups = "drop"),
        by = "value" 
      ) %>%
      mutate(n = replace_na(n, 0))
   
    plot_data <- plot_data %>%
      mutate(answer_label = factor(answer_label, levels = meta_group$answer_label))
   
    ggplot(plot_data, aes(x = fct_reorder(answer_label, desc(order)), y = n)) +
      geom_col(fill = "#f68060", alpha = 0.6, width = 0.4) +
      coord_flip() +
      scale_y_reverse() +
      geom_text(aes(label = n),
                hjust = -0.1, size = 3) +
      scale_x_discrete(labels = ~ stringr::str_wrap(.x, width = wrap_width),
                       position = "top") +
      labs(x = NULL, y = "Count", title = wrapped_title) +
      theme_classic() +
      theme(
        axis.text.y = element_text(angle = 0, hjust = 1),   # ← corrected axis
        plot.title.position = "plot",
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10, unit = "pt")
      )
  }
}





plot_question(data, meta, "Q16a")


#ggsave("barplotnew.png", width = 10, height = 6, dpi = 300)

# To do for these plots:
# - Make sure the axes are comparable
# - Make it laying down
# - Add value labels -> top down
# - Only the yes should be indicated
# maybe percentages for better comparisons between groups? or plot them both in the same plot?


```

## Making some plots

```{r}

all_questions <- c("Q2", "Q3", "Q4", "Q5", "Q6", "Q7a", "Q7b", "Q8", "Q9", "Q10a", "Q10b", "Q11", "Q12", "Q13a", "Q13b", "Q14", "Q15", "Q16a", "Q16b", 
  "Q17", "Q18a", "Q18b", "Q19", "Q20", "Q21", "Q22", "Q23", "Q24", "Q25")

for (i in 1:length(all_questions)) {
  print(plot_question(data, meta, all_questions[i]))
}

```

## Old Scraps that are not needed anymore

```{r}

# Make plot base for all plots here?
# plot_base <- 


#### Question 4: Project Tasks ####
## Complete sample ##

# Select columns to include
Q4_select <- data %>%
  select(Q4_1, Q4_2, Q4_3, Q4_4, Q4_5)

# Pivot to long format
Q4_long <- Q4_select %>%
  pivot_longer(cols = everything(),
               names_to = "question",
               values_to = "selected")

# Plot barplot
ggplot(Q4_long, aes(question, fill = factor(selected))) +
  geom_bar(position = position_dodge(preserve = "single")) +
  scale_fill_manual(labels = c("0" = "Didn't select", "1" = "Selected"), values = c("0" = "red", "1" = "blue"))

## Filtered on New Method ##
Q4_newmethod <- data %>%
  filter(new_method == 1) %>%
  select(Q4_1, Q4_2, Q4_3, Q4_4, Q4_5)

# Pivot to longer format
Q4_long_newmethod <- Q4_newmethod %>%
  pivot_longer(cols = everything(),
               names_to = "question",
               values_to = "selected")

ggplot(Q4_long_newmethod, aes(question, fill = factor(selected))) +
  geom_bar(position = position_dodge(preserve = "single")) +
  scale_fill_manual(labels = c("0" = "Didn't select", "1" = "Selected"), values = c("0" = "red", "1" = "blue"))


## Filtered neutral (new_method = 0)
Q4_neutral <- data %>%
  filter(new_method == 0) %>%
  select(Q4_1, Q4_2, Q4_3, Q4_4, Q4_5)

# Pivot to longer format
Q4_long_neutral <- Q4_neutral %>%
  pivot_longer(cols = everything(),
               names_to = "question",
               values_to = "selected")

ggplot(Q4_long_neutral, aes(question, fill = factor(selected))) +
  geom_bar(position = position_dodge(preserve = "single")) +
  scale_fill_manual(labels = c("0" = "Didn't select", "1" = "Selected"), values = c("0" = "red", "1" = "blue"))

# Vectors for questions
question_4 <- c("Q4_1", "Q4_2", "Q4_3", "Q4_4", "Q4_5")
question_7a <- c("Q7a_1", "Q7a_2", "Q7a_3", "Q7a_4", "Q7a_5", "Q7a_6", "Q7a_7", "Q7a_8", "Q7a_9", "Q7a_10", "Q7a_11", "Q7a_12")


# answer options
a_Q7a <- c(
  "… adhere to journal requirements (e.g., maximum number of words/tables/figures)", 
  "… improve the readability of the paper", 
  "… increase the chance of publication (e.g., report results likely to be of interest to editor/reviewers)", 
  "… implement suggestions from an editor or peer-reviewer", 
  "… focus on the most relevant results", 
  "… focus on statistically significant results", 
  "… focus on unexpected results", 
  "… focus on results that aligned with the paper’s main conclusions", 
  "… focus on results that show when a method ‘breaks’", 
  "… focus on results that illustrate the strengths of a specific method",
  "… focus on results for the best-performing method", 
  "Other, please specify [open-ended]"
)


# This way the NA values are removed
# Plot for the entire dataset
data %>%
  pivot_longer(
    cols = question_7a,
    names_to = "question",
    values_to = "selected"
  ) %>%
  filter(selected == 1) %>%
  mutate(question = factor(question, levels = question_7a)) %>% # fix the order so it is not on alfabetical order but order of answers
  ggplot(aes(x = question)) +
  geom_bar(fill = "steelblue") +
  coord_flip() +
  geom_text(stat = "count", aes(label = after_stat(count)), 
            hjust = -0.1, size = 3) +
  scale_x_discrete(labels = str_wrap(a_Q7a, width = 55)) +
  theme_classic() # try some other things

# Plot for the data for only new method = true
data %>%
  filter(new_method == 1) %>%
  pivot_longer(
    cols = question_7a,
    names_to = "question",
    values_to = "selected"
  ) %>%
  filter(selected == 1) %>%
  mutate(question = factor(question, levels = question_7a)) %>%
  ggplot(aes(x = question)) +
  geom_bar(fill = "steelblue") + 
  coord_flip() +
  geom_text(stat = "count", aes(label = after_stat(count)), 
            hjust = -0.1, size = 3) +
  scale_x_discrete(labels = str_wrap(a_Q7a, width = 55)) +
  theme_classic()

```
